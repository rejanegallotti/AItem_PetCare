import os
from dotenv import load_dotenv
import google.generativeai as genai # Apenas esta importa√ß√£o de genai √© necess√°ria
from google.adk.agents import Agent
from google.adk.runners import Runner
from google.adk.sessions import InMemorySessionService
from google.adk.tools import google_search
from google.genai import types
import textwrap
from IPython.display import display, Markdown # Pode ser ignorado se n√£o estiver em ambiente de notebook
import warnings
import re

warnings.filterwarnings("ignore")

print("Iniciando script...")

# --- Configura√ß√£o da API Key ---
load_dotenv()
print("Arquivo .env carregado.")

api_key = os.getenv("GOOGLE_API_KEY")
print(f"Valor da API_KEY (encontrada/n√£o encontrada): {api_key is not None}")

if api_key:
    # A configura√ß√£o da API Key √© feita diretamente na inicializa√ß√£o do cliente genai.Client()
    # O m√©todo genai.configure() n√£o √© mais usado desta forma para as vers√µes mais recentes.
    print("API do Google Gemini sendo configurada...")
else:
    print("ERRO: Vari√°vel de ambiente 'GOOGLE_API_KEY' N√ÉO encontrada.")
    print("Por favor, defina sua chave API como uma vari√°vel de ambiente ou em um arquivo .env na raiz do projeto.")
    exit()

# Inicializa o cliente genai com a API Key
MODEL_ID = "gemini-2.0-flash" # Modelo mais est√°vel e dispon√≠vel

# --- Fun√ß√£o para filtrar resposta ---
def filtrar_resposta_revisor(resposta_bruta):
    """
    Filtra a resposta do agente revisor para mostrar apenas o conte√∫do relevante ao usu√°rio,
    removendo logs t√©cnicos e metadados gerados pelo revisor.
    """
    padrao = r"Resposta revisada:(.*?)(?=\n-{3,}|\Z)"
    match = re.search(padrao, resposta_bruta, re.DOTALL | re.IGNORECASE)

    if match:
        resposta_limpa = match.group(1).strip()
        resposta_limpa = re.sub(r'\*\*Revis√µes:\*\*.*?(?=\*\*Resposta revisada:\*\*|\Z)', '', resposta_limpa, flags=re.DOTALL | re.IGNORECASE)
        resposta_limpa = re.sub(r'^(?:agente \w+ est√° pensando|ferramenta \w+ usada:).*', '', resposta_limpa, flags=re.MULTILINE | re.IGNORECASE)
        return resposta_limpa.strip()
    return resposta_bruta # Fallback: retorna a resposta bruta se o padr√£o n√£o for encontrado

# --- Fun√ß√µes Auxiliares ---
def call_agent(agent: Agent, message_text: str) -> str:
    """
    Envia uma mensagem para um agente usando o Runner do Google ADK e retorna a resposta final.
    """
    session_service = InMemorySessionService()
    # Para este exemplo, manter 'session_pet_care' est√° ok para execu√ß√µes independentes
    session = session_service.create_session(app_name=agent.name, user_id="user1", session_id="session_pet_care")
    runner = Runner(agent=agent, app_name=agent.name, session_service=session_service)
    content = types.Content(role="user", parts=[types.Part(text=message_text)])

    final_response = ""
    for event in runner.run(user_id="user1", session_id="session_pet_care", new_message=content):
        if event.is_final_response():
            for part in event.content.parts:
                if part.text is not None:
                    final_response += part.text
            break
    return final_response

def format_response(text):
    """
    Formata o texto para exibi√ß√£o em Markdown (ou para console).
    """
    text = text.replace('‚Ä¢', ' *') # Seu PDF mostrava '‚Ä¢', corrigi para '*'
    # Se estiver no VS Code e n√£o usando um notebook Jupyter, 'display(Markdown(...)) n√£o renderizar√°.
    # 'textwrap.indent' ajuda na leitura do console.
    return textwrap.indent(text, '> ')

# --- Agentes --- (Todos centralizados aqui)

def agente_saude(sintomas: str, pet_name: str):
    """
    Agente especializado em avaliar sintomas de pets e fornecer recomenda√ß√µes preliminares.
    Utiliza a ferramenta de busca do Google para obter informa√ß√µes adicionais.
    """
    saude_agent = Agent(
        name="agente_saude",
        model=MODEL_ID,
        instruction=f"""
        Voc√™ √© um veterin√°rio virtual, especialista em triagem de sintomas de pets.
        Seu objetivo √© analisar os sintomas fornecidos pelo tutor sobre seu pet, {pet_name}.
        1. D√™ um diagn√≥stico inicial prov√°vel ou lista de poss√≠veis causas.
        2. Liste sinais de alerta claros que indicariam uma emerg√™ncia (ex: v√¥mito com sangue = urg√™ncia, dificuldade respirat√≥ria = emerg√™ncia).
        3. Recomende a√ß√µes claras para o tutor, incluindo quando e se deve "Levar ao veterin√°rio imediatamente", "Observar por X horas e se persistir levar ao veterin√°rio", ou "Pode ser cuidado em casa com observa√ß√£o".
        Use um tom emp√°tico, informativo e evite termos t√©cnicos sem explica√ß√£o.
        SEMPRE inclua um aviso CLARO que sua resposta N√ÉO SUBSTITUI um diagn√≥stico profissional
        de um veterin√°rio e que, em caso de emerg√™ncia, o pet deve ser levado a um veterin√°rio imediatamente.
        """,
        description="Agente de diagn√≥stico veterin√°rio para triagem de sintomas.",
        tools=[google_search]
    )
    return call_agent(saude_agent, f"Os sintomas de {pet_name} s√£o: {sintomas}")

def agente_dieta(pet_name: str, especie: str, peso: str, alergias: str = ""):
    """
    Agente especialista em fornecer dicas de dieta personalizada e natural para pets.
    Pode usar a ferramenta de busca do Google para pesquisar informa√ß√µes nutricionais.
    """
    dieta_agent = Agent(
        name="agente_dieta",
        model=MODEL_ID,
        instruction=f"""
        Voc√™ √© um nutricionista de pets AI, especialista em dietas balanceadas e naturais.
        Seu objetivo √© criar um plano alimentar ou dar orienta√ß√µes diet√©ticas para o pet, {pet_name}.
        1. Baseado na esp√©cie, peso e alergias informadas, sugira diretrizes gerais de dieta (ex: propor√ß√µes de prote√≠nas, carboidratos, vegetais).
        2. Liste alimentos seguros e perigosos comuns para a esp√©cie.
        3. Forne√ßa exemplos de refei√ß√µes ou lanches.
        SEMPRE inclua um aviso CLARO que esta √© uma orienta√ß√£o geral e N√ÉO substitui a consulta e o
        plano personalizado de um nutricionista veterin√°rio qualificado, e que dietas desbalanceadas podem ser
        prejudiciais.
        """,
        description="Agente de nutri√ß√£o animal para planos alimentares e orienta√ß√µes.",
        tools=[google_search]
    )
    input_message = f"Crie um plano alimentar para o pet {pet_name}:\n- Esp√©cie: {especie}\n- Peso: {peso}\n- Alergias: {alergias if alergias else 'Nenhuma'}"
    return call_agent(dieta_agent, input_message)

def agente_treinamento(pet_name: str, comando: str):
    """
    Agente especialista em fornecer dicas de adestramento dom√©stico com refor√ßo positivo.
    Pode usar a ferramenta de busca do Google para pesquisar t√©cnicas espec√≠ficas.
    """
    treino_agent = Agent(
        name="agente_treinamento",
        model=MODEL_ID,
        instruction=f"""
        Voc√™ √© um adestrador de pets AI, focado em t√©cnicas de refor√ßo positivo.
        Seu objetivo √© ensinar o tutor como treinar seu pet, {pet_name}, para o comando ou comportamento
        espec√≠fico: '{comando}'.
        1. Descreva o passo a passo claro para o treinamento.
        2. Mencione a import√¢ncia de paci√™ncia, consist√™ncia e sess√µes curtas.
        3. Sugira tipos de recompensas eficazes.
        SEMPRE inclua um aviso CLARO que para problemas de comportamento persistentes ou
        complexos, um adestrador profissional ou comportamentalista veterin√°rio √© recomendado.
        """,
        description="Agente de treinamento animal para dicas e passo a passo.",
        tools=[google_search]
    )
    return call_agent(treino_agent, f"Como treinar {pet_name} para '{comando}'?")

def agente_revisor(resposta_para_revisar: str) -> str:
    """
    Agente revisor de conte√∫do, focado na seguran√ßa e clareza das respostas geradas.
    """
    revisor_agent = Agent(
        name="agente_revisor",
        model=MODEL_ID, # Voc√™ pode considerar um modelo mais "robusto" aqui como 'gemini-1.5-pro'
        instruction="""
        Voc√™ √© um Editor e Revisor de Conte√∫do meticuloso, especializado em conselhos sobre pets.
        Sua fun√ß√£o √© revisar uma resposta gerada por outro agente sobre cuidados com pets.
        1. Verifique se h√° conselhos potencialmente perigosos, enganosos ou eticamente incorretos (ex: "d√™ rem√©dio humano", "ignore dor"). Se encontrar, aponte e sugira a remo√ß√£o.
        2. Garanta que a linguagem seja clara, concisa, emp√°tica e f√°cil de entender para tutores leigos.
        3. Assegure-se de que todos os avisos de seguran√ßa e a recomenda√ß√£o de procurar um profissional
        (veterin√°rio, adestrador, nutricionista) estejam presentes e sejam proeminentes.
        4. Sugira melhorias gerais na reda√ß√£o, estrutura ou tom se necess√°rio.
        5. Sua sa√≠da final deve ser formatada como "Resposta revisada: [a resposta polida e segura]".
        Se houver problemas significativos que voc√™ corrigiu, detalhe as "Revis√µes:" antes da "Resposta
        revisada:".
        Se a resposta original √© *muito* perigosa, diga "Aten√ß√£o: A resposta original cont√©m conselhos
        perigosos e foi drasticamente alterada para seguran√ßa. [Nova resposta segura]".
        """,
        description="Revisor de seguran√ßa e qualidade para conselhos sobre pets."
    )
    return call_agent(revisor_agent, f'Por favor, revise a seguinte resposta sobre cuidados com pets:\n\n{resposta_para_revisar}')

# --- Sistema Unificado AI tem PetCare ---
def ai_tem_petcare():
    print("üêæ Bem-vindo ao AI tem PetCare! Escolha uma op√ß√£o para seu amigo de quatro patas:")
    print("1. Diagn√≥stico de Sa√∫de (Sintomas, alertas e recomenda√ß√µes)")
    print("2. Dieta Personalizada (Orienta√ß√µes de nutri√ß√£o e alimentos)")
    print("3. Treinamento (Dicas para comandos e comportamentos)")
    print("4. Sair")

    pet_name = input("Qual o nome do seu pet? (Ou deixe em branco para 'seu pet'): ").strip()
    if not pet_name:
        pet_name = "seu pet"

    while True:
        print("\n--- Menu Principal ---")
        print("1. Sa√∫de\n2. Dieta\n3. Treinamento\n4. Sair")
        opcao = input("Digite o n√∫mero da op√ß√£o desejada: ")

        resposta_bruta_agente = ""
        resposta_do_revisor = ""
        resposta_final_exibicao = ""

        if opcao == "1":
            sintomas = input(f"Descreva os sintomas ou preocupa√ß√µes de sa√∫de de {pet_name}: ")
            if sintomas:
                print(f"\n--- üìù Consultando o Agente de Sa√∫de sobre {pet_name} ---")
                resposta_bruta_agente = agente_saude(sintomas, pet_name)
                print(f"\n--- üîé Enviando para Revis√£o de Qualidade ---")
                resposta_do_revisor = agente_revisor(resposta_bruta_agente)
                resposta_final_exibicao = filtrar_resposta_revisor(resposta_do_revisor)
            else:
                print("Por favor, descreva os sintomas.")
                continue
        elif opcao == "2":
            especie = input("Esp√©cie (ex: 'cachorro', 'gato'): ")
            peso = input("Peso (ex: '5kg', '20kg'): ")
            alergias = input("Alergias conhecidas (deixe em branco se n√£o houver): ")
            if especie and peso:
                print(f"\n--- üìù Consultando o Agente de Nutri√ß√£o sobre {pet_name} ---")
                resposta_bruta_agente = agente_dieta(pet_name, especie, peso, alergias)
                print(f"\n--- üîé Enviando para Revis√£o de Qualidade ---")
                resposta_do_revisor = agente_revisor(resposta_bruta_agente)
                resposta_final_exibicao = filtrar_resposta_revisor(resposta_do_revisor)
            else:
                print("Por favor, forne√ßa a esp√©cie e o peso.")
                continue
        elif opcao == "3":
            comando = input(f"O que voc√™ gostaria de ensinar {pet_name}? (ex: 'sentar', 'n√£o latir'): ")
            if comando:
                print(f"\n--- üìù Consultando o Agente de Treinamento sobre {pet_name} ---")
                resposta_bruta_agente = agente_treinamento(pet_name, comando)
                print(f"\n--- üîé Enviando para Revis√£o de Qualidade ---")
                resposta_do_revisor = agente_revisor(resposta_bruta_agente)
                resposta_final_exibicao = filtrar_resposta_revisor(resposta_do_revisor)
            else:
                print("Por favor, descreva o que deseja ensinar.")
                continue
        elif opcao == "4":
            print(f"Obrigado por usar o AI tem PetCare para cuidar de {pet_name}! Volte sempre.")
            break
        else:
            print("Op√ß√£o inv√°lida. Por favor, digite um n√∫mero de 1 a 4.")
            continue

        if resposta_final_exibicao:
            print("\n--- ‚úÖ Resposta Final AI tem PetCare ---")
            print(format_response(resposta_final_exibicao))
        else:
            print("\nNenhuma resposta gerada para a op√ß√£o selecionada ou houve um problema na gera√ß√£o/revis√£o.")
        print("\n--------------------------------------------------------------")

if __name__ == "__main__":
    print("Chamando a fun√ß√£o principal 'ai_tem_petcare()'")
    ai_tem_petcare()